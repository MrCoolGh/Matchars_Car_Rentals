<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta tags  -->
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

  <title>Chat</title>
    <link rel="icon" type="image/png" href="../img/about-img.png">

  <!-- CSS Assets -->
  <link rel="stylesheet" href="../assets/css/app.css">

  <!-- Javascript Assets -->
  <script src="../assets/js/app.js" defer=""></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="css2?family=Inter:wght@400;500;600;700&family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
  <script>
    /**
     * THIS SCRIPT REQUIRED FOR PREVENT FLICKERING IN SOME BROWSERS
     */
    localStorage.getItem("_x_darkMode_on") === "true" &&
    document.documentElement.classList.add("dark");
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get current user from localStorage
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

      // Only allow admins to stay on the page
      if (!currentUser || !currentUser.id || currentUser.role !== 'manager') {
        // Redirect non-admin users to homepage (or another appropriate page)
        window.location.href = '../all_users/homepage.html';
      }
      // If the user is admin, they stay on the page
    });
  </script>

  <style>
    .pad{
      padding:3rem 4rem 0 4rem;
    }
  </style>
</head>

<body x-data="" class="is-header-blur" x-bind="$store.global.documentBody">
<!-- App preloader-->
<div class="app-preloader fixed z-50 grid h-full w-full place-content-center bg-slate-50 dark:bg-navy-900">
  <div class="app-preloader-inner relative inline-block size-48"></div>
</div>

<!-- Page Wrapper -->
<div id="root" class="min-h-100vh flex grow bg-slate-50 dark:bg-navy-900" x-cloak="">

  <!-- Sidebar -->
  <div class="sidebar print:hidden" x-data="sidebarUser()">
    <!-- Main Sidebar -->
    <div class="main-sidebar">
      <div class="flex h-full w-full flex-col items-center border-r border-slate-150 bg-white dark:border-navy-700 dark:bg-navy-800">

        <!-- Application Logo -->
        <div class="flex pt-4">
          <!-- Profile -->
          <div x-data="usePopper({placement:'right-end',offset:12})" @click.outside="isShowPopper && (isShowPopper = false)" class="flex">
            <button @click="isShowPopper = !isShowPopper" x-ref="popperRef" class="avatar size-12">
              <img class="rounded-full" :src="userAvatar" :alt="userName" onerror="this.src='../images/avatar/avatar-12.jpg'">
              <span class="absolute right-0 size-3.5 rounded-full border-2 border-white bg-success dark:border-navy-700"></span>
            </button>

            <div :class="isShowPopper && 'show'" class="popper-root fixed" x-ref="popperRoot">
              <div class="popper-box w-64 rounded-lg border border-slate-150 bg-white shadow-soft dark:border-navy-600 dark:bg-navy-700">
                <div class="flex items-center space-x-4 rounded-t-lg bg-slate-100 py-5 px-4 dark:bg-navy-800">
                  <div class="avatar size-14">
                    <img class="rounded-full" :src="userAvatar" :alt="userName" onerror="this.src='../images/avatar/avatar-12.jpg'">
                  </div>
                  <div>
                    <a href="#" class="text-base font-medium text-slate-700 hover:text-primary focus:text-primary dark:text-navy-100 dark:hover:text-accent-light dark:focus:text-accent-light" x-text="userName">
                      User Name
                    </a>
                    <p class="text-xs text-slate-400 dark:text-navy-300" x-text="userRole">
                      Role
                    </p>
                  </div>
                </div>
                <div class="flex flex-col pt-2 pb-5">
                  <a href="../all_users/homepage.html" class="group flex items-center space-x-3 py-2 px-4 tracking-wide outline-none transition-all hover:bg-slate-100 focus:bg-slate-100 dark:hover:bg-navy-600 dark:focus:bg-navy-600">
                    <div class="flex size-8 items-center justify-center rounded-lg bg-error text-white">
                      <svg xmlns="http://www.w3.org/2000/svg" class="size-4.5" fill="none" viewbox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                      </svg>
                    </div>
                    <div>
                      <h2 class="font-medium text-slate-700 transition-colors group-hover:text-primary group-focus:text-primary dark:text-navy-100 dark:group-hover:text-accent-light dark:group-focus:text-accent-light">
                        Home Page
                      </h2>
                      <div class="text-xs text-slate-400 line-clamp-1 dark:text-navy-300">
                        Go to home page
                      </div>
                    </div>
                  </a>

                  <div class="mt-3 px-4">
                    <button @click="logout" class="btn h-9 w-full space-x-2 bg-primary text-white hover:bg-primary-focus focus:bg-primary-focus active:bg-primary-focus/90 dark:bg-accent dark:hover:bg-accent-focus dark:focus:bg-accent-focus dark:active:bg-accent/90">
                      <svg xmlns="http://www.w3.org/2000/svg" class="size-5" fill="none" viewbox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                      </svg>
                      <span>Logout</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Sections Links -->
        <div class="is-scrollbar-hidden flex grow flex-col space-y-4 overflow-y-auto pt-6">
          <!-- Dashboards -->
          <a href="manager_dashboard.html" class="flex size-11 items-center justify-center rounded-lg outline-none transition-colors duration-200 hover:bg-primary/20 focus:bg-primary/20 active:bg-primary/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25" x-tooltip.placement.right="'Dashboards'">
            <svg class="size-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24">
              <path fill="currentColor" fill-opacity=".3" d="M5 14.059c0-1.01 0-1.514.222-1.945.221-.43.632-.724 1.453-1.31l4.163-2.974c.56-.4.842-.601 1.162-.601.32 0 .601.2 1.162.601l4.163 2.974c.821.586 1.232.88 1.453 1.31.222.43.222.935.222 1.945V19c0 .943 0 1.414-.293 1.707C18.414 21 17.943 21 17 21H7c-.943 0-1.414 0-1.707-.293C5 20.414 5 19.943 5 19v-4.94Z"></path>
              <path fill="currentColor" d="M3 12.387c0 .267 0 .4.084.441.084.041.19-.04.4-.204l7.288-5.669c.59-.459.885-.688 1.228-.688.343 0 .638.23 1.228.688l7.288 5.669c.21.163.316.245.4.204.084-.04.084-.174.084-.441v-.409c0-.48 0-.72-.102-.928-.101-.208-.291-.355-.67-.65l-7-5.445c-.59-.459-.885-.688-1.228-.688-.343 0-.638.23-1.228.688l-7 5.445c-.379.295-.569.442-.67.65-.102.208-.102.448-.102.928v.409Z"></path>
              <path fill="currentColor" d="M11.5 15.5h1A1.5 1.5 0 0 1 14 17v3.5h-4V17a1.5 1.5 0 0 1 1.5-1.5Z"></path>
              <path fill="currentColor" d="M17.5 5h-1a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5Z"></path>
            </svg>
          </a>

          <!-- Admin Bookings -->
          <a href="manager_bookings.html" class="flex size-11 items-center justify-center rounded-lg outline-none transition-colors duration-200 hover:bg-primary/20 focus:bg-primary/20 active:bg-primary/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25" x-tooltip.placement.right="'Manage Bookings'">
            <svg class="size-7" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9.85714 3H4.14286C3.51167 3 3 3.51167 3 4.14286V9.85714C3 10.4883 3.51167 11 4.14286 11H9.85714C10.4883 11 11 10.4883 11 9.85714V4.14286C11 3.51167 10.4883 3 9.85714 3Z" fill="currentColor"></path>
              <path d="M9.85714 12.8999H4.14286C3.51167 12.8999 3 13.4116 3 14.0428V19.757C3 20.3882 3.51167 20.8999 4.14286 20.8999H9.85714C10.4883 20.8999 11 20.3882 11 19.757V14.0428C11 13.4116 10.4883 12.8999 9.85714 12.8999Z" fill="currentColor" fill-opacity="0.3"></path>
              <path d="M19.757 3H14.0428C13.4116 3 12.8999 3.51167 12.8999 4.14286V9.85714C12.8999 10.4883 13.4116 11 14.0428 11H19.757C20.3882 11 20.8999 10.4883 20.8999 9.85714V4.14286C20.8999 3.51167 20.3882 3 19.757 3Z" fill="currentColor" fill-opacity="0.3"></path>
              <path d="M19.757 12.8999H14.0428C13.4116 12.8999 12.8999 13.4116 12.8999 14.0428V19.757C12.8999 20.3882 13.4116 20.8999 14.0428 20.8999H19.757C20.3882 20.8999 20.8999 20.3882 20.8999 19.757V14.0428C20.8999 13.4116 20.3882 12.8999 19.757 12.8999Z" fill="currentColor" fill-opacity="0.3"></path>
            </svg>
          </a>

          <!-- Forms -->
          <a href="manager_forms.html" class="flex size-11 items-center justify-center rounded-lg outline-none transition-colors duration-200 hover:bg-primary/20 focus:bg-primary/20 active:bg-primary/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25" x-tooltip.placement.right="'Manage Forms'">
              <svg class="size-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                  <rect x="2" y="10" width="20" height="10" rx="1.5" fill="currentColor" fill-opacity="0.20"/>
                  <rect x="3.5" y="5.5" width="17" height="10" rx="1.5" fill="currentColor" fill-opacity="0.45"/>
                  <rect x="6" y="1" width="12" height="8" rx="1.25" fill="currentColor" fill-opacity="0.95"/>
                  <line x1="8" y1="3.5" x2="16" y2="3.5" stroke="white" stroke-width="1" stroke-linecap="round" opacity="0.95"/>
                  <line x1="8" y1="5.5" x2="14" y2="5.5" stroke="white" stroke-width="1" stroke-linecap="round" opacity="0.95"/>
              </svg>
          </a>

          <!-- Chat - Active Page -->
          <a href="manager_chat.html" class="flex size-11 items-center justify-center rounded-lg bg-primary/10 text-primary outline-none transition-colors duration-200 hover:bg-primary/20 focus:bg-primary/20 active:bg-primary/25 dark:bg-navy-600 dark:text-accent-light dark:hover:bg-navy-450 dark:focus:bg-navy-450 dark:active:bg-navy-450/90" x-tooltip.placement.right="'Chat'">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.009 9.009 0 01-5-1.563l-4.223.885.898-4.21A8.962 8.962 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
          </a>

          <!-- Users -->
          <a href="manager_manage_users.html" class="flex size-11 items-center justify-center rounded-lg outline-none transition-colors duration-200 hover:bg-primary/20 focus:bg-primary/20 active:bg-primary/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25" x-tooltip.placement.right="'Manage Users'">
            <!-- UPDATED ICON: Users / Manage Users (only the SVG changed) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="size-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <!-- Two person heads -->
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 11a4 4 0 100-8 4 4 0 000 8zM17 13a3 3 0 100-6 3 3 0 000 6z"/>
              <!-- Primary user body -->
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 20.25a6.75 6.75 0 0113.5 0V21a.75.75 0 01-.75.75H3.75A.75.75 0 013 21v-.75z"/>
              <!-- Secondary user body (smaller, to the right) -->
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 21.75a.75.75 0 01-.75-.75v-.75a7.46 7.46 0 01.6-2.97 5.25 5.25 0 015.4 0A7.46 7.46 0 0122.5 20.25v.75a.75.75 0 01-.75.75h-5.25z"/>
            </svg>
          </a>

          <!-- staff -->
          <a href="manager_manage_staff.html" class="flex size-11 items-center justify-center rounded-lg outline-none transition-colors duration-200 hover:bg-primary/20 focus:bg-primary/20 active:bg-primary/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25" x-tooltip.placement.right="'Manage Staff'">
            <!-- UPDATED ICON (different users-style icon) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="size-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <!-- Center user -->
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 12.5c2.071 0 3.75-1.679 3.75-3.75S14.071 5 12 5s-3.75 1.679-3.75 3.75S9.929 12.5 12 12.5z"/>
              <!-- Left user (behind) -->
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M6.25 11.25A3 3 0 106.26 5.5"/>
              <!-- Right user (behind) -->
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M17.75 11.25A3 3 0 1017.74 5.5"/>
              <!-- Center body -->
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M6.75 18.5c0-2.9 2.66-5.25 5.25-5.25s5.25 2.35 5.25 5.25v.75a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75v-.75z"/>
              <!-- Side bodies (outline suggestion of group) -->
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3.5 19c0-2.1 1.44-3.95 3.17-4.57M20.5 19c0-2.1-1.44-3.95-3.17-4.57"/>
            </svg>
          </a>

          <!-- Cars -->
          <a href="manager_manage_cars.html"
             class="flex size-11 items-center justify-center rounded-lg outline-none transition-colors duration-200 hover:bg-primary/20 focus:bg-primary/20 active:bg-primary/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25"
             x-tooltip.placement.right="'Manage Cars'">
            <!-- Replaced icon with a car icon (only change) -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="size-7"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 13h18l-1.5-4.5a2 2 0 0 0-1.9-1.4H6.4a2 2 0 0 0-1.9 1.4L3 13Z"/>
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 13v5a1 1 0 0 0 1 1h1.2a2 2 0 0 0 3.6 0h6.4a2 2 0 0 0 3.6 0H20a1 1 0 0 0 1-1v-5"/>
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M6 13l1-3h10l1 3"/>
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M7.5 18h.01M16.5 18h.01"/>
            </svg>
          </a>
        </div>

        <!-- Bottom Links -->
        <div class="flex flex-col items-center space-y-3 py-3">
          <!-- Settings -->
          <a href="manager_edit_profile.html" class="flex size-11 items-center justify-center rounded-lg outline-none transition-colors duration-200 hover:bg-primary/20 focus:bg-primary/20 active:bg-primary/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25">
            <svg class="size-7" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-opacity="0.3" fill="currentColor" d="M2 12.947v-1.771c0-1.047.85-1.913 1.899-1.913 1.81 0 2.549-1.288 1.64-2.868a1.919 1.919 0 0 1 .699-2.607l1.729-.996c.79-.474 1.81-.192 2.279.603l.11.192c.9 1.58 2.379 1.58 3.288 0l.11-.192c.47-.795 1.49-1.077 2.279-.603l1.73.996a1.92 1.92 0 0 1 .699 2.607c-.91 1.58-.17 2.868 1.639 2.868 1.04 0 1.899.856 1.899 1.912v1.772c0 1.047-.85 1.912-1.9 1.912-1.808 0-2.548 1.288-1.638 2.869.52.915.21 2.083-.7 2.606l-1.729.997c-.79.473-1.81.191-2.279-.604l-.11-.191c-.9-1.58-2.379-1.58-3.288 0l-.11.19c-.47.796-1.49 1.078-2.279.605l-1.73-.997a1.919 1.919 0 0 1-.699-2.606c.91-1.58.17-2.869-1.639-2.869A1.911 1.911 0 0 1 2 12.947Z"></path>
              <path fill="currentColor" d="M11.995 15.332c1.794 0 3.248-1.464 3.248-3.27 0-1.807-1.454-3.272-3.248-3.272-1.794 0-3.248 1.465-3.248 3.271 0 1.807 1.454 3.271 3.248 3.271Z"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>

    <!-- Sidebar Panel -->
    <div class="sidebar-panel">
      <div class="flex h-full grow flex-col bg-white pl-[var(--main-sidebar-width)] dark:bg-navy-750">
        <!-- Sidebar Panel Header -->
        <div class="flex h-18 w-full items-center justify-between pl-4 pr-1">
          <p class="text-base tracking-wider text-slate-800 dark:text-navy-100">
            Customer Support Chat
          </p>
          <button @click="$store.global.isSidebarExpanded = false" class="btn size-7 rounded-full p-0 text-primary hover:bg-slate-300/20 focus:bg-slate-300/20 active:bg-slate-300/25 dark:text-accent-light/80 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25 xl:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-6" fill="none" viewbox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
        </div>

        <!-- Sidebar Panel Body -->
        <div x-data="{expandedItem:null}" class="h-[calc(100%-4.5rem)] overflow-x-hidden pb-6" x-init="$el._x_simplebar = new SimpleBar($el);">
          <ul class="flex flex-1 flex-col px-4 font-inter">
            <li>
              <a x-data="navLink" class="flex py-2 text-xs+ tracking-wide outline-none transition-colors duration-300 ease-in-out text-slate-600 hover:text-slate-900 dark:text-navy-200 dark:hover:text-navy-50">
                Respond to customer inquiries and provide support for booking issues, car information, or general assistance.
              </a>
            </li>
          </ul>

          <ul class="flex flex-1 flex-col px-4 font-inter mt-4">
            <li>
              <p class="py-2 text-xs+ tracking-wide text-slate-500 dark:text-navy-300">
                Current Time: <span x-text="currentDateTime"></span>
              </p>
            </li>
            <li>
              <p class="py-2 text-xs+ tracking-wide text-slate-500 dark:text-navy-300">
                Logged in as: <span x-text="userName"></span>
              </p>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- User Authentication & Profile Alpine Component -->
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('sidebarUser', () => ({
        userAvatar: '../images/avatar/avatar-12.jpg', // Default avatar
        userName: 'Lyk-no-boss', // Using the provided username
        userRole: 'Manager',
        currentDateTime: '2025-08-06 15:25:20', // Exact time from provided data

        init() {
          // Check if user is logged in
          this.checkUserAuth();

          // Redirect to login if not authenticated
          if (!this.isAuthenticated()) {
            window.location.href = '../auth/sign_in.html';
          }
        },

        checkUserAuth() {
          const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

          if (currentUser && currentUser.id) {
            // Set user information
            this.userName = currentUser.firstName && currentUser.lastName ?
                    `${currentUser.firstName} ${currentUser.lastName}` :
                    (currentUser.username || 'Lyk-no-boss');

            this.userRole = this.capitalizeFirstLetter(currentUser.role || 'Manager');

            // Set avatar if available
            if (currentUser.avatar &&
                    currentUser.avatar !== 'null' &&
                    currentUser.avatar !== 'undefined') {
              this.userAvatar = currentUser.avatar;
            }
          }
        },

        isAuthenticated() {
          const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
          return !!currentUser.id;
        },

        capitalizeFirstLetter(string) {
          return string.charAt(0).toUpperCase() + string.slice(1);
        },

        logout() {
          // Clear user data from localStorage
          localStorage.removeItem('currentUser');

          // Redirect to login page
          window.location.href = '../auth/sign_in.html';
        }
      }));
    });
  </script>

  <!-- App Header Wrapper-->
  <nav class="header before:bg-white dark:before:bg-navy-750 print:hidden">
    <!-- App Header  -->
    <div class="header-container relative flex w-full bg-white dark:bg-navy-750 print:hidden">
      <!-- Header Items -->
      <div class="flex w-full items-center justify-between">

        <!-- Left: Sidebar Toggle Button -->
        <div class="size-7">
          <button class="menu-toggle ml-0.5 flex size-7 flex-col justify-center space-y-1.5 text-primary outline-none focus:outline-none dark:text-accent-light/80" :class="$store.global.isSidebarExpanded && 'active'" @click="$store.global.isSidebarExpanded = !$store.global.isSidebarExpanded">
            <span></span>
            <span></span>
            <span></span>
          </button>
        </div>

        <!-- Right: Header buttons -->
        <div class="-mr-1.5 flex items-center space-x-2">



          <!-- Dark Mode Toggle -->
          <button @click="$store.global.isDarkModeEnabled = !$store.global.isDarkModeEnabled" class="btn size-8 rounded-full p-0 hover:bg-slate-300/20 focus:bg-slate-300/20 active:bg-slate-300/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25">
            <svg x-show="$store.global.isDarkModeEnabled" x-transition:enter="transition-transform duration-200 ease-out absolute origin-top" x-transition:enter-start="scale-75" x-transition:enter-end="scale-100 static" class="size-6 text-amber-400" fill="currentColor" viewbox="0 0 24 24">
              <path d="M11.75 3.412a.818.818 0 01-.07.917 6.332 6.332 0 00-1.4 3.971c0 3.564 2.98 6.494 6.706 6.494a6.86 6.86 0 002.856-.617.818.818 0 011.1 1.047C19.593 18.614 16.218 21 12.283 21 7.18 21 3 16.973 3 11.956c0-4.563 3.46-8.31 7.925-8.948a.818.818 0 01.826.404z"></path>
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" x-show="!$store.global.isDarkModeEnabled" x-transition:enter="transition-transform duration-200 ease-out absolute origin-top" x-transition:enter-start="scale-75" x-transition:enter-end="scale-100 static" class="size-6 text-amber-400" viewbox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
            </svg>
          </button>

          <!-- Monochrome Mode Toggle -->
          <button @click="$store.global.isMonochromeModeEnabled = !$store.global.isMonochromeModeEnabled" class="btn size-8 rounded-full p-0 hover:bg-slate-300/20 focus:bg-slate-300/20 active:bg-slate-300/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25">
            <i class="fa-solid fa-palette bg-gradient-to-r from-sky-400 to-blue-600 bg-clip-text text-lg font-semibold text-transparent"></i>
          </button>

          <!-- Right Sidebar home page icon -->
          <button
                  @click="window.location.href = '../all_users/homepage.html'; $store.global.isRightSidebarExpanded = true"
                  class="btn size-8 rounded-full p-0 hover:bg-slate-300/20 focus:bg-slate-300/20 active:bg-slate-300/25 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="size-5.5 text-slate-500 dark:text-navy-100" fill="none" viewbox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
            </svg>
          </button>

        </div>
      </div>
    </div>
  </nav>


  <!-- ================== ENHANCED LIVE SIDE PANEL (ADDED) ================== -->
  <div
          class="sidebar-panel"
          x-data="chatSidebarPanel()"
          x-init="init()"
  >
    <div class="flex h-full grow flex-col bg-white pl-[var(--main-sidebar-width)] dark:bg-navy-750">

      <!-- Sidebar Panel Header (UNCHANGED) -->
      <div class="flex h-18 w-full items-center justify-between pl-4 pr-1">
        <div class="flex items-center">
          <div class="avatar mr-3 hidden size-9 lg:flex">
            <div class="is-initial rounded-full bg-primary/10 text-primary dark:bg-accent-light/10 dark:text-accent-light">
              <svg xmlns="http://www.w3.org/2000/svg" class="size-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
              </svg>
            </div>
          </div>
          <p class="text-lg font-medium tracking-wider text-slate-800 line-clamp-1 dark:text-navy-100">
            Chat
          </p>
        </div>

        <button
                @click="$store.global.isSidebarExpanded = false"
                class="btn size-7 rounded-full p-0 text-primary hover:bg-slate-300/20 focus:bg-slate-300/20 active:bg-slate-300/25 dark:text-accent-light/80 dark:hover:bg-navy-300/20 dark:focus:bg-navy-300/20 dark:active:bg-navy-300/25 xl:hidden"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="size-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
      </div>

      <!-- Sidebar Panel Body -->
      <div class="flex h-[calc(100%-4.5rem)] grow flex-col">

        <!-- Search + Filters -->
        <div class="flex px-4 pt-4">
          <label class="relative mr-1.5 flex flex-1">
            <input
                    x-model="searchQuery"
                    class="form-input peer h-8 w-full rounded-lg bg-slate-150 px-3 py-2 pl-9 text-xs+ ring-primary/50 placeholder:text-slate-400 hover:bg-slate-200 focus:ring dark:bg-navy-900/90 dark:ring-accent/50 dark:placeholder:text-navy-300 dark:hover:bg-navy-900 dark:focus:bg-navy-900"
                    placeholder="Search chats"
                    type="text"
            >
            <span class="pointer-events-none absolute flex h-full w-10 items-center justify-center text-slate-400 peer-focus:text-primary dark:text-navy-300 dark:peer-focus:text-accent">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-4 transition-colors duration-200" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3.316 13.781l.73-.171-.73.171zm0-5.457l.73.171-.73-.171zm15.473 0l.73-.171-.73.171zm0 5.457l.73.171-.73-.171zm-5.008 5.008l-.171-.73.171.73zm-5.457 0l-.171.73.171-.73zm0-15.473l-.171-.73.171.73zm5.457 0l.171-.73-.171.73zM20.47 21.53a.75.75 0 101.06-1.06l-1.06 1.06zM4.046 13.61a11.198 11.198 0 010-5.115l-1.46-.342a12.698 12.698 0 000 5.8l1.46-.343zm14.013-5.115a11.196 11.196 0 010 5.115l1.46.342a12.698 12.698 0 000-5.8l-1.46.343zm-4.45 9.564a11.196 11.196 0 01-5.114 0l-.342 1.46c1.907.448 3.892.448 5.8 0l-.343-1.46zM8.496 4.046a11.198 11.198 0 015.115 0l.342-1.46a12.698 12.698 0 00-5.8 0l.343 1.46zm0 14.013a5.97 5.97 0 01-4.45-4.45l-1.46.343a7.47 7.47 0 005.568 5.568l.342-1.46zm5.457 1.46a7.47 7.47 0 005.568-5.567l-1.46-.342a5.97 5.97 0 01-4.45 4.45l.342 1.46z"/>
            </svg>
          </span>
          </label>

          <div
                  x-data="usePopper({placement:'bottom-end',offset:4})"
                  @click.outside="isShowPopper && (isShowPopper = false)"
                  class="inline-flex"
          >
            <button
                    x-ref="popperRef"
                    @click="isShowPopper = !isShowPopper"
                    class="btn -mr-2 size-8 shrink-0 rounded-full p-0 text-slate-500 hover:bg-slate-300/20 hover:text-primary focus:bg-slate-300/20 focus:text-primary active:bg-slate-300/25 dark:text-navy-200 dark:hover:bg-navy-300/20 dark:hover:text-accent dark:focus:bg-navy-300/20 dark:focus:text-accent dark:active:bg-navy-300/25"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="size-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M22 6.5h-9.5M6 6.5H2M9 9a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM22 17.5h-6M9.5 17.5H2M13 20a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"/>
              </svg>
            </button>
            <div x-ref="popperRoot" class="popper-root" :class="isShowPopper && 'show'">
              <div class="popper-box rounded-md border border-slate-150 bg-white p-3 font-inter dark:border-navy-500 dark:bg-navy-700">
                <div class="flex flex-col space-y-2">
                  <p class="font-medium text-slate-600 dark:text-navy-100">Filter by Status</p>
                  <label class="inline-flex items-center space-x-2">
                    <input
                            x-model="filters.unread"
                            class="form-checkbox is-basic size-4 rounded border-slate-400/70 checked:border-primary checked:bg-primary hover:border-primary focus:border-primary dark:border-navy-400 dark:checked:border-accent dark:checked:bg-accent dark:hover:border-accent dark:focus:border-accent"
                            type="checkbox">
                    <span class="text-slate-600 dark:text-navy-100">Unread</span>
                  </label>
                  <div class="my-2 h-px bg-slate-200 dark:bg-navy-500"></div>
                  <p class="font-medium text-slate-600 dark:text-navy-100">Filter by User Type</p>
                  <!-- Admin filter left visually but will not produce results (admins removed) -->

                  <label class="inline-flex items-center space-x-2">
                    <input x-model="filters.manager" class="form-checkbox is-basic size-4 rounded border-slate-400/70 checked:border-primary checked:bg-primary hover:border-primary focus:border-primary dark:border-navy-400 dark:checked:border-accent dark:checked:bg-accent dark:hover:border-accent dark:focus:border-accent" type="checkbox">
                    <span class="text-slate-600 dark:text-navy-100">Manager</span>
                  </label>
                  <label class="inline-flex items-center space-x-2">
                    <input x-model="filters.customer" class="form-checkbox is-basic size-4 rounded border-slate-400/70 checked:border-primary checked:bg-primary hover:border-primary focus:border-primary dark:border-navy-400 dark:checked:border-accent dark:checked:bg-accent dark:hover:border-accent dark:focus:border-accent" type="checkbox">
                    <span class="text-slate-600 dark:text-navy-100">Customer</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading / Error / Empty -->
        <div class="px-4 pt-3" x-show="isLoadingUsers">
          <p class="text-xs text-slate-500 dark:text-navy-300">Loading users...</p>
        </div>
        <div class="px-4 pt-3" x-show="!isLoadingUsers && errorUsers">
          <p class="text-xs text-error" x-text="errorUsers"></p>
        </div>
        <div class="px-4 pt-3" x-show="!isLoadingUsers && !errorUsers && filteredChats.length === 0">
          <p class="text-xs text-slate-400 dark:text-navy-300">No users match your filters.</p>
        </div>

        <!-- Users List -->
        <div class="is-scrollbar-hidden mt-3 flex grow flex-col overflow-y-auto">
          <template x-for="chat in filteredChats" :key="chat.chatId">
            <div
                    @click="openChat(chat)"
                    class="flex cursor-pointer items-center space-x-2.5 px-4 py-2.5 font-inter hover:bg-slate-150 dark:hover:bg-navy-600"
            >
              <div class="avatar size-10 rounded-full overflow-hidden relative">
                <div class="is-initial rounded-full ring-2"
                     :class="{
                     'ring-info': chat.userType === 'Customer',
                     'ring-warning': chat.userType === 'Manager'
                   }">
                  <img class="rounded-full object-cover w-full h-full" :src="chat.avatar_url" :alt="chat.name">
                </div>
                <!-- Presence dot -->
                <span
                        class="absolute bottom-0 right-0 size-3 rounded-full border-2 border-white dark:border-navy-700"
                        :class="chat.online ? 'bg-green-500' : 'bg-slate-400'"
                        :title="chat.online ? 'Online' : (chat.last_seen ? ('Last seen: ' + formatRelative(chat.last_seen)) : 'Offline')"
                ></span>
              </div>
              <div class="flex flex-1 flex-col">
                <div class="flex items-baseline justify-between space-x-1.5">
                  <p
                          class="text-xs+ font-medium text-slate-700 line-clamp-1 dark:text-navy-100"
                          x-text="chat.name"
                  ></p>
                  <span
                          class="text-tiny+ text-slate-400 dark:text-navy-300"
                          x-text="chat.timestamp || ''"
                  ></span>
                </div>
                <div class="mt-1 flex items-center justify-between space-x-1">
                  <p
                          class="text-xs+ text-slate-400 line-clamp-1 dark:text-navy-300"
                          x-text="typingUsers.has(chat.chatId)
                           ? 'Typing...'
                           : (chat.lastMessage || ('Role: ' + chat.userType))"
                  ></p>
                  <div
                          x-show="chat.unreadCount > 0"
                          class="flex h-4.5 min-w-[1.125rem] items-center justify-center rounded-full bg-primary px-1.5 text-tiny+ font-medium leading-none text-white dark:bg-accent"
                          x-text="chat.unreadCount"
                  ></div>
                </div>
              </div>
            </div>
          </template>
        </div>

      </div>
    </div>
  </div>
  <script>
    function chatSidebarPanel() {
      return {
        /* ---------------- STATE ---------------- */
        searchQuery: '',
        filters: { unread: false, admin: false, manager: false, customer: false },
        chats: [],
        isLoadingUsers: true,
        errorUsers: null,
        currentUser: {},
        typingUsers: new Set(),
        socketPresence: null,
        unreadInitialized: false,

        /* --------------- INIT --------------- */
        async init() {
          /* ADDED: Auto-expand sidebar on page load */
          try {
            if (this.$store?.global) {
              this.$store.global.isSidebarExpanded = true;
            }
          } catch(e) {
            console.warn('Auto expand sidebar failed', e);
          }
          this.loadCurrentUser();
          await this.fetchUsers();
          await this.fetchUnreadSummary();
          await this.fetchPresenceSnapshot();
          this.setupGlobalListeners();
          this.initPresenceSocket();
        },

        /* --------------- LOAD CURRENT USER --------------- */
        loadCurrentUser() {
          try {
            const stored = localStorage.getItem('currentUser');
            if (stored) this.currentUser = JSON.parse(stored);
          } catch(e) {
            this.currentUser = {};
          }
        },

        /* --------------- FETCH USERS --------------- */
        async fetchUsers() {
          this.errorUsers = null;
          this.isLoadingUsers = true;
          try {
            let res = await fetch('/admin/api/users');
            if (!res.ok) {
              const fallback = await fetch('/api/users');
              if (!fallback.ok) throw new Error('Failed to fetch users');
              res = fallback;
            }
            const data = await res.json();
            const arr = Array.isArray(data) ? data : [];
            this.chats = arr.map(u => {
              const first = u.first_name ?? u.firstName ?? '';
              const last  = u.last_name ?? u.lastName ?? '';
              const full  = (first + ' ' + last).trim() || u.name || 'Unknown User';
              const role  = (u.role || 'Customer');
              return {
                chatId: u.id || u._id,
                name: full,
                userType: role,
                avatar_url: u.avatar || u.profile_image || u.profileImage || '../images/avatar/default.jpg',
                unreadCount: 0,
                lastMessage: '',
                timestamp: '',
                online: false,
                last_seen: null
              };
            });

            /* ================= ADDED: Exclude current user and all admins ================= */
            this.chats = this.chats.filter(c => {
              const role = (c.userType || '').toLowerCase();
              const isAdmin = role === 'admin';
              const isSelf = this.currentUser && (String(c.chatId) === String(this.currentUser.id));
              return !isAdmin && !isSelf; // keep only non-admin & not myself
            });
            /* ============================================================================== */

          } catch (e) {
            console.error(e);
            this.errorUsers = 'Could not load users.';
            this.chats = [];
          } finally {
            this.isLoadingUsers = false;
          }
        },

        /* --------------- UNREAD SUMMARY --------------- */
        async fetchUnreadSummary() {
          if (!this.currentUser.id) return;
          try {
            const res = await fetch(`/api/chat/unread-summary?currentUserId=${this.currentUser.id}`);
            if (!res.ok) return;
            const summary = await res.json();
            summary.forEach(s => {
              const c = this.chats.find(ch => ch.chatId == s.otherUserId);
              if (c) {
                c.unreadCount = s.unreadCount;
                if (s.lastMessage) c.lastMessage = s.lastMessage;
                if (s.lastTime)   c.timestamp   = this.formatTime(s.lastTime);
              }
            });
          } catch(e) {
            console.warn('Unread summary failed', e);
          }
        },

        /* --------------- PRESENCE SNAPSHOT (DB last_seen) --------------- */
        async fetchPresenceSnapshot() {
          if (!this.chats.length) return;
          const ids = this.chats.map(c=>c.chatId).join(',');
          try {
            const res = await fetch(`/api/chat/presence?userIds=${ids}`);
            if (!res.ok) return;
            const data = await res.json();
            data.forEach(p => {
              const c = this.chats.find(ch => ch.chatId == p.userId);
              if (c) {
                c.last_seen = p.last_seen;
              }
            });
          } catch(e) {
            console.warn('Presence snapshot failed', e);
          }
        },

        /* --------------- SOCKET: PRESENCE + TYPING --------------- */
        initPresenceSocket() {
          if (!this.currentUser.id || this.socketPresence) return;
          this.socketPresence = io('/', { auth: { userId: this.currentUser.id } });

          this.socketPresence.on('chat:presence', payload => {
            const c = this.chats.find(ch => ch.chatId == payload.userId);
            if (c) {
              c.online = payload.status === 'online';
              if (payload.last_seen) c.last_seen = payload.last_seen;
            }
          });

          this.socketPresence.on('chat:typing', ({ from }) => {
            this.typingUsers.add(from);
          });
          this.socketPresence.on('chat:stop_typing', ({ from }) => {
            this.typingUsers.delete(from);
          });

          this.socketPresence.on('chat:new_message', ({ message }) => {
            /* placeholder for potential future logic */
          });
        },

        /* --------------- WINDOW EVENTS FROM MAIN CHAT --------------- */
        setupGlobalListeners() {
          window.addEventListener('chat-unread', (ev) => {
            const { userId, message } = ev.detail || {};
            const c = this.chats.find(ch => ch.chatId == userId);
            if (c) {
              c.unreadCount += 1;
              if (message) {
                c.lastMessage = (message.type === 'image') ? '[Image]' : message.content;
                c.timestamp = this.formatTime(message.created_at);
              }
            }
          });

          window.addEventListener('chat-update-last', (ev) => {
            const { userId, message } = ev.detail || {};
            const c = this.chats.find(ch => ch.chatId == userId);
            if (c && message) {
              c.lastMessage = (message.type === 'image') ? '[Image]' : message.content;
              c.timestamp   = this.formatTime(message.created_at);
            }
          });
        },

        /* --------------- OPEN CHAT --------------- */
        async openChat(chat) {
          this.typingUsers.delete(chat.chatId);
          this.$dispatch('change-active-chat', {
            chatId: chat.chatId,
            avatar_url: chat.avatar_url,
            name: chat.name
          });

          /* ADDED: Collapse the side panel when a user is selected */
          try {
            if (this.$store?.global) {
              this.$store.global.isSidebarExpanded = false;
            }
          } catch(e) {
            console.warn('Could not hide sidebar', e);
          }

          if (chat.unreadCount > 0 && this.currentUser.id) {
            try {
              await fetch('/api/chat/messages/read', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                  currentUserId: this.currentUser.id,
                  otherUserId: chat.chatId
                })
              });
            } catch(e) {
              console.warn('Mark read failed', e);
            }
          }
          chat.unreadCount = 0;
        },

        /* --------------- FILTERED LIST --------------- */
        get filteredChats() {
          let filtered = [...this.chats];

          /* Safety filter again: ensure no admins or self appear (in case of later mutations) */
          filtered = filtered.filter(c => {
            const role = (c.userType || '').toLowerCase();
            const isAdmin = role === 'admin';
            const isSelf = this.currentUser && (String(c.chatId) === String(this.currentUser.id));
            return !isAdmin && !isSelf;
          });

          if (this.searchQuery.trim()) {
            const q = this.searchQuery.toLowerCase();
            filtered = filtered.filter(c => c.name.toLowerCase().includes(q));
          }

          // Only allow manager/customer role filters (admin ignored)
          const activeRoleFilters = [];
          if (this.filters.manager) activeRoleFilters.push('manager');
          if (this.filters.customer) activeRoleFilters.push('customer');

          if (activeRoleFilters.length) {
            filtered = filtered.filter(c =>
                    activeRoleFilters.includes((c.userType || '').toLowerCase())
            );
          }

          if (this.filters.unread) {
            filtered = filtered.filter(c => c.unreadCount > 0);
          }

          filtered.sort((a,b) => {
            if (b.unreadCount !== a.unreadCount) return b.unreadCount - a.unreadCount;
            return a.name.localeCompare(b.name);
          });

          return filtered;
        },

        /* --------------- TIME HELPERS --------------- */
        formatTime(ts) {
          if (!ts) return '';
          const d = new Date(ts);
          if (isNaN(d)) return '';
          return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        },
        formatRelative(ts) {
          if (!ts) return '';
          const d = new Date(ts);
          if (isNaN(d)) return '';
          const diffMs = Date.now() - d.getTime();
          const mins = Math.floor(diffMs/60000);
          if (mins < 1) return 'just now';
          if (mins < 60) return mins + 'm ago';
          const hrs = Math.floor(mins/60);
          if (hrs < 24) return hrs + 'h ago';
          const days = Math.floor(hrs/24);
          return days + 'd ago';
        }
      };
    }
  </script>
  <!-- ================== END ENHANCED SIDE PANEL ================== -->



  <!-- ================== ENHANCED LIVE MAIN CHAT ================== -->
  <style>
    :root {
      --chat-safe-top: 5px;
    }
    @media (max-width: 640px) {
      :root {
        --chat-safe-top: 5px;
      }
    }
    .chat-header-shadow {
      box-shadow: 0 2px 4px -2px rgba(0,0,0,.04), 0 4px 6px -1px rgba(0,0,0,.04);
    }
  </style>
  <main
          x-data="realChatApp()"
          x-init="init()"
          class="main-content h-100vh chat-app mt-0 flex w-full flex-col relative"
          @change-active-chat.window="selectActiveChat($event.detail)"
  >
    <div x-show="!activeChat" class="flex h-full flex-col items-center justify-center">
      <div class="flex items-center justify-center text-center">
        <div class="w-2/4">
          <p class="pt-2 text-lg font-medium text-slate-800 dark:text-navy-100">
            Select a chat to start messaging
          </p>
        </div>
      </div>
    </div>

    <!-- ACTIVE CHAT -->
    <template x-if="activeChat">
      <div class="flex h-full flex-col">

        <!-- ======= ADDED: Spacer to push everything below fixed global top bar ======= -->
        <div aria-hidden="true" class="w-full" :style="`height: calc(var(--chat-safe-top) - 60px)`"></div>

        <!-- ======= ADDED: Sticky Chat Header (with extra larger padding) ======= -->
        <div
                class="sticky top-0 z-20 flex items-center gap-4
               px-8 py-5
               bg-white/95 backdrop-blur border-b border-slate-150
               dark:bg-navy-800/90 dark:border-navy-600
               chat-header-shadow"
                :style="`margin-top: calc(-1 * (var(--chat-safe-top) - 60px))`"
        >
          <div class="relative">
            <img :src="activeChat.avatar_url"
                 class="h-14 w-14 rounded-full object-cover ring-2 ring-primary/20 dark:ring-accent/40"
                 alt="avatar">
            <!-- Presence dot (if you wire presence here) -->
            <span
                    x-show="activeChatPresenceStatus === 'online'"
                    class="absolute bottom-0 right-0 h-3.5 w-3.5 rounded-full border-2 border-white dark:border-navy-800 bg-green-500"
            ></span>
          </div>
          <div class="flex flex-col min-w-0">
            <p class="font-semibold text-base md:text-lg text-slate-800 dark:text-navy-50 truncate" x-text="activeChat.name"></p>
            <p class="text-xs md:text-[11px] tracking-wide uppercase text-slate-500 dark:text-navy-300"
               x-text="activeChatPresenceText || 'Active chat'"></p>
          </div>
          <div class="ml-auto flex items-center gap-2">
            <!-- Optional header actions -->
          </div>
        </div>

        <!-- LOAD EARLIER BUTTON -->
        <div class="px-8 pt-4" x-show="hasMore(activeChat.chatId)">
          <button
                  @click="loadEarlier(activeChat.chatId)"
                  class="text-xs font-medium text-primary hover:underline dark:text-accent"
                  :disabled="loadingEarlier"
                  x-text="loadingEarlier ? 'Loading...' : 'Load earlier messages'"
          ></button>
        </div>

        <!-- SCROLL AREA -->
        <div
                x-ref="chatContainer"
                :class="$store?.breakpoints?.smAndUp && 'scrollbar-sm'"
                class="grow overflow-y-auto px-8 pt-6 pb-6 transition-all duration-200"
        >
          <div class="space-y-5">
            <template x-for="(chat, index) in (messages[activeChat.chatId] || [])" :key="chat.id || index">
              <div>
                <div
                        class="flex items-start space-x-2.5 sm:space-x-5"
                        :class="chat.from === 'me' && 'justify-end'"
                >
                  <!-- Their avatar -->
                  <div class="avatar shrink-0" x-show="chat.from === 'them'">
                    <img class="h-10 w-10 rounded-full object-cover" :src="activeChat.avatar_url" alt="">
                  </div>

                  <!-- Message Bubble -->
                  <div class="flex flex-col items-start space-y-3.5"
                       :class="chat.from === 'me' && 'items-end'">
                    <div class="max-w-xl"
                         :class="chat.from === 'me' ? 'ml-4 sm:ml-10' : 'mr-4 sm:mr-10'">

                      <!-- Text -->
                      <template x-if="chat.type === 'text'">
                        <div
                                class="rounded-2xl px-4 py-2.5 text-slate-700 shadow-sm leading-relaxed break-words text-sm"
                                :class="chat.from === 'me'
                           ? 'rounded-tr-none bg-primary/10 text-slate-800 dark:bg-accent dark:text-white'
                           : 'rounded-tl-none bg-white dark:bg-navy-700 dark:text-navy-100'"
                                x-text="chat.content"
                        ></div>
                      </template>

                      <!-- Image -->
                      <template x-if="chat.type === 'image'">
                        <div class="rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-navy-600 max-w-md">
                          <img
                                  class="max-h-80 object-contain bg-slate-50 dark:bg-navy-700"
                                  :src="chat.image_url || chat.content"
                                  alt="image message">
                        </div>
                      </template>

                      <!-- Time -->
                      <p
                              class="mt-1 ml-auto text-[10px] font-medium tracking-wide uppercase text-slate-400 dark:text-navy-300"
                              :class="chat.from === 'me' ? 'text-left' : 'text-right'"
                              x-text="formatTime(chat.created_at)"
                      ></p>
                    </div>
                  </div>

                  <!-- My avatar -->
                  <div class="avatar shrink-0" x-show="chat.from === 'me'">
                    <img class="h-10 w-10 rounded-full object-cover"
                         :src="currentUser.avatar || '/images/avatar/default.jpg'"
                         alt="">
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- TYPING INDICATOR -->
        <div class="px-8 -mb-1" x-show="typingActive">
          <p class="text-xs text-slate-500 dark:text-navy-300" x-text="activeChat.name + ' is typing...'"></p>
        </div>

        <!-- COMPOSER -->
        <div class="chat-footer-wrapper">
          <div x-show="imagePreviewUrl" class="p-3 relative">
            <img :src="imagePreviewUrl" class="h-28 w-28 rounded-lg object-cover shadow-sm">
            <button
                    @click="clearImagePreview"
                    class="absolute top-0 right-0 m-1 btn size-6 rounded-full bg-slate-200 p-0 text-slate-700 hover:bg-slate-300 dark:bg-navy-600 dark:text-navy-100 dark:hover:bg-navy-500"
            >
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
          <div
                  class="chat-footer relative flex h-16 w-full shrink-0 items-center justify-between
                 border-t border-slate-150 bg-white px-8
                 dark:border-navy-600 dark:bg-navy-800"
          >
            <div class="flex flex-1 items-center space-x-3">
              <input type="file" class="hidden" x-ref="fileInput" @change="handleFileSelect($event)" accept="image/*">
              <button
                      @click="$refs.fileInput.click()"
                      class="btn size-10 shrink-0 rounded-full p-0 text-slate-500 hover:bg-slate-300/20 dark:text-navy-200 dark:hover:bg-navy-600/40"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="size-5.5" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                </svg>
              </button>
              <input
                      type="text"
                      x-model="message"
                      @keydown="handleTypingKey"
                      @keydown.enter.prevent="sendMessage"
                      class="form-input h-11 w-full bg-transparent placeholder:text-slate-400/70 text-sm"
                      placeholder="Write the message"
                      :disabled="!activeChat || sending"
              >
            </div>
            <div class="flex items-center">
              <button
                      @click="sendMessage"
                      class="btn size-11 shrink-0 rounded-full p-0 text-primary hover:bg-primary/15 active:bg-primary/20 dark:text-accent-light dark:hover:bg-accent/20"
                      :disabled="!activeChat || sending"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="size-6" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="m9.813 5.146 9.027 3.99c4.05 1.79 4.05 4.718 0 6.508l-9.027 3.99c-6.074 2.686-8.553.485-5.515-4.876l.917-1.613c.232-.41.232-1.09 0-1.5l-.917-1.623C1.26 4.66 3.749 2.46 9.813 5.146ZM6.094 12.389h7.341"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

      </div>
    </template>
  </main>
  <script>
    if (typeof realChatApp === 'function') {
      const _origRealChatApp = realChatApp;
      realChatApp = function() {
        const ctx = _origRealChatApp();
        if (ctx.activeChatPresenceStatus === undefined) ctx.activeChatPresenceStatus = 'offline';
        if (ctx.activeChatPresenceText === undefined) ctx.activeChatPresenceText = '';
        const oldSelect = ctx.selectActiveChat?.bind(ctx);
        ctx.selectActiveChat = async (detail) => {
          if (oldSelect) await oldSelect(detail);
          // Placeholder presence refresh hook
        };
        return ctx;
      }
    }
  </script>
  <script>
    function realChatApp() {
      return {
        activeChat: null,
        currentUser: {},
        messages: {},
        paginationState: {},
        message: '',
        imageFile: null,
        imagePreviewUrl: null,
        socket: null,
        sending: false,
        loadingEarlier: false,
        typingActive: false,
        typingTimeout: null,
        typingNotifySent: false,
        typingDebounceTimer: null,
        stopTypingTimer: null,

        init() {
          this.loadCurrentUser();
          this.initSocket();
        },

        loadCurrentUser() {
          try {
            const stored = localStorage.getItem('currentUser');
            if (stored) this.currentUser = JSON.parse(stored);
          } catch(e) { this.currentUser = {}; }
        },

        initSocket() {
          if (!this.currentUser.id) return;
          this.socket = io('/', { auth: { userId: this.currentUser.id } });

          this.socket.on('chat:new_message', ({ conversationId, message }) => {
            const otherId = (message.sender_id === this.currentUser.id)
                    ? message.receiver_id
                    : message.sender_id;
            if (!this.messages[otherId]) this.messages[otherId] = [];
            this.messages[otherId].push(this.transformMessage(message));
            this.messages[otherId].sort((a,b)=>a.id - b.id);

            const isActive = this.activeChat && this.activeChat.chatId == otherId;
            if (isActive) {
              this.$nextTick(() => this.scrollToBottom());
              if (message.sender_id !== this.currentUser.id) {
                this.markRead(otherId);
              }
            } else {
              window.dispatchEvent(new CustomEvent('chat-unread', {
                detail: { userId: otherId, message }
              }));
            }
            window.dispatchEvent(new CustomEvent('chat-update-last', {
              detail: { userId: otherId, message }
            }));
          });

          this.socket.on('chat:typing', ({ from }) => {
            if (this.activeChat && this.activeChat.chatId == from) {
              this.typingActive = true;
              if (this.typingTimeout) clearTimeout(this.typingTimeout);
              this.typingTimeout = setTimeout(()=> {
                this.typingActive = false;
              }, 2500);
            }
          });
          this.socket.on('chat:stop_typing', ({ from }) => {
            if (this.activeChat && this.activeChat.chatId == from) {
              this.typingActive = false;
            }
          });
        },

        transformMessage(m) {
          return {
            id: m.id,
            from: (m.sender_id === this.currentUser.id) ? 'me' : 'them',
            type: m.type,
            content: m.image_url ? m.image_url : m.content,
            image_url: m.image_url || null,
            created_at: m.created_at
          };
        },

        async selectActiveChat(detail) {
          if (!detail?.chatId) return;
          this.activeChat = detail;
          if (!this.messages[detail.chatId]) {
            await this.fetchMessages(detail.chatId);
          }
          await this.markRead(detail.chatId);
          this.typingActive = false;
          this.$nextTick(() => this.scrollToBottom());
        },

        async fetchMessages(otherUserId, opts = {}) {
          if (!this.currentUser.id) return;
          const params = new URLSearchParams();
          params.set('currentUserId', this.currentUser.id);
          if (opts.beforeId) params.set('beforeId', opts.beforeId);
          else {
            params.set('page', '1');
            params.set('pageSize', '30');
          }
          try {
            const res = await fetch(`/api/chat/messages/${otherUserId}?` + params.toString());
            if (!res.ok) throw new Error('Failed to load messages');
            const data = await res.json();
            const newMsgs = data.messages.map(m => this.transformMessage(m));
            if (opts.beforeId) {
              this.messages[otherUserId] = newMsgs.concat(this.messages[otherUserId] || []);
            } else {
              this.messages[otherUserId] = newMsgs;
            }
            this.paginationState[otherUserId] = {
              hasMore: data.hasMore,
              beforeIdNext: data.pagination.beforeIdNext
            };
            this.messages[otherUserId].sort((a,b)=> a.id - b.id);
          } catch(e) {
            console.error(e);
          }
        },

        hasMore(userId) {
          return this.paginationState[userId]?.hasMore;
        },

        async loadEarlier(userId) {
          if (!this.hasMore(userId) || this.loadingEarlier) return;
          this.loadingEarlier = true;
          try {
            const oldest = this.messages[userId]?.[0];
            if (!oldest) return;
            await this.fetchMessages(userId, { beforeId: oldest.id });
          } finally {
            this.loadingEarlier = false;
          }
        },

        async markRead(otherUserId) {
          if (!this.currentUser.id) return;
          try {
            await fetch('/api/chat/messages/read', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ currentUserId: this.currentUser.id, otherUserId })
            });
          } catch(e) { console.warn('markRead failed', e); }
        },

        handleFileSelect(e) {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            this.imageFile = file;
            this.imagePreviewUrl = URL.createObjectURL(file);
          }
        },
        clearImagePreview() {
          this.imageFile = null;
          this.imagePreviewUrl = null;
        },

        async uploadImageFile() {
          if (!this.imageFile) return null;
          const fd = new FormData();
          fd.append('image', this.imageFile);
          const res = await fetch('/api/chat/upload-image', {
            method: 'POST',
            body: fd
          });
          if (!res.ok) throw new Error('Upload failed');
          const data = await res.json();
          return data.url;
        },

        async sendMessage() {
          if (!this.activeChat || this.sending) return;
          const trimmed = this.message.trim();
          const isImage = !!this.imageFile;
          if (!trimmed && !isImage) return;

          const now = new Date().toISOString();
          const temp = {
            id: 'tmp_' + Date.now(),
            from: 'me',
            type: isImage ? 'image' : 'text',
            content: isImage ? this.imagePreviewUrl : trimmed,
            image_url: isImage ? this.imagePreviewUrl : null,
            created_at: now
          };
          if (!this.messages[this.activeChat.chatId]) this.messages[this.activeChat.chatId] = [];
          this.messages[this.activeChat.chatId].push(temp);
          this.messages[this.activeChat.chatId].sort((a,b)=> a.id - b.id);
          this.$nextTick(()=> this.scrollToBottom());

          window.dispatchEvent(new CustomEvent('chat-update-last', {
            detail: {
              userId: this.activeChat.chatId,
              message: { type: temp.type, content: trimmed, image_url: temp.image_url, created_at: temp.created_at }
            }
          }));

          let imageUrlServer = null;
          try {
            this.sending = true;
            if (isImage) {
              imageUrlServer = await this.uploadImageFile();
            }
            const body = {
              currentUserId: this.currentUser.id,
              to: this.activeChat.chatId,
              type: isImage ? 'image' : 'text',
              content: !isImage ? trimmed : (trimmed || ''),
              imageUrl: isImage ? imageUrlServer : null
            };
            this.message = '';
            this.clearImagePreview();
            await fetch('/api/chat/messages', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify(body)
            });
            this.stopTypingEmit();
          } catch(e) {
            console.error(e);
          } finally {
            this.sending = false;
          }
        },

        handleTypingKey() {
          if (!this.activeChat) return;
          if (!this.typingNotifySent) {
            this.socket?.emit('chat:typing', { to: this.activeChat.chatId });
            this.typingNotifySent = true;
          }
          if (this.stopTypingTimer) clearTimeout(this.stopTypingTimer);
          this.stopTypingTimer = setTimeout(() => {
            this.stopTypingEmit();
          }, 1800);
        },

        stopTypingEmit() {
          if (this.typingNotifySent) {
            this.socket?.emit('chat:stop_typing', { to: this.activeChat?.chatId });
            this.typingNotifySent = false;
          }
        },

        scrollToBottom() {
          const el = this.$refs.chatContainer;
          if (el) el.scrollTop = el.scrollHeight;
        },

        formatTime(ts) {
          if (!ts) return '';
          const d = new Date(ts);
          if (isNaN(d)) return '';
          return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }
      }
    }
  </script>
  <!-- ================== ENHANCED LIVE MAIN CHAT ENDE ================== -->


</div>

<div id="x-teleport-target"></div>
<script>
  window.addEventListener("DOMContentLoaded", () => Alpine.start());
</script>

</body>
</html>
